<div class="noAutorizado-wrap" *ngIf="!this.allowed">
  <i class="fa fa-lock" aria-hidden="true"></i>
</div>
<div *ngIf="this.allowed" class="container">
  <h2>Productos</h2>
  <app-tree (TreeChangeEvent)="buscar($event)"></app-tree>
  <form class="form-wrap mt-2" (ngSubmit)="buscar()">
    <div class="filtros-wrap">
      <div class="filtros" *ngFor="let tipoInput of listaInputsParaMostrar">
        <!-- Codigos -->
        <div
          class="codigos-wrap"
          *ngIf="tipoInput.descripcion.toLowerCase() === 'codigo'"
        >
          <!-- Codigo Select -->
          <mat-form-field
            *ngIf="tipoInput.descripcion.toLowerCase() === 'codigo'"
            class="codigo-select"
            focused="false"
            appearance="outline"
          >
            <mat-label>Tipo Codigo</mat-label>
            <mat-select
              *ngIf="tipoInput.descripcion.toLowerCase() === 'codigo'"
              [(ngModel)]="codigoSelected"
              name="codigo"
              [(value)]="codigoSelected"
            >
              <mat-option
                *ngFor="let codigo of codigoInput; let i = index"
                [value]="i"
              >
                {{ codigo.descripcion | uppercase }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <!-- Codigo -->
          <mat-form-field
            class="codigo-input"
            *ngIf="tipoInput.descripcion.toLowerCase() === 'codigo'"
            focused="false"
            appearance="outline"
          >
            <mat-label>{{ tipoInput.descripcion }}</mat-label>
            <input
              *ngIf="tipoInput.descripcion.toLowerCase() === 'codigo'"
              matInput
              type="text"
              [formControl]="codigoFormControl"
            />
            <div
              class="clear-option"
              mat-button
              *ngIf="
                codigoFormControl.value &&
                tipoInput.descripcion.toLowerCase() === 'codigo'
              "
              matSuffix
              mat-icon-button
              aria-label="Clear"
              (click)="codigoFormControl.setValue('')"
            >
              <mat-icon>close</mat-icon>
            </div>
          </mat-form-field>
        </div>

        <!-- Detalle -->
        <mat-form-field
          *ngIf="tipoInput.descripcion.toLowerCase() === 'detalle'"
          focused="false"
          appearance="outline"
        >
          <mat-label>{{ tipoInput.descripcion }}</mat-label>
          <input
            *ngIf="tipoInput.descripcion.toLowerCase() === 'detalle'"
            matInput
            type="text"
            [formControl]="detalleFormControl"
          />
          <div
            class="clear-option"
            clear-option
            mat-button
            *ngIf="
              detalleFormControl.value &&
              tipoInput.descripcion.toLowerCase() === 'detalle'
            "
            matSuffix
            mat-icon-button
            aria-label="Clear"
            (click)="detalleFormControl.setValue('')"
          >
            <mat-icon>close</mat-icon>
          </div>
        </mat-form-field>
        <!-- Proveedor -->
        <mat-form-field
          *ngIf="tipoInput.descripcion.toLowerCase() === 'proveedor'"
          focused="false"
          appearance="outline"
        >
          <mat-label>{{ tipoInput.descripcion }}</mat-label>
          <mat-select
            *ngIf="tipoInput.descripcion.toLowerCase() === 'proveedor'"
            [(ngModel)]="proveedorSelected"
            name="proveedor"
          >
            <mat-option>
              <ngx-mat-select-search
                placeholderLabel="Buscar proveedor"
                noEntriesFoundLabel="Proveedor no encontrado"
                [formControl]="bankFilterCtrl"
              ></ngx-mat-select-search>
            </mat-option>
            <mat-option
              *ngFor="let proveedor of proveedores"
              [value]="proveedor.Codigo"
            >
              {{ proveedor.Nombre }}
            </mat-option>
          </mat-select>
          <div
            clear-option
            mat-button
            *ngIf="
              proveedorSelected &&
              tipoInput.descripcion.toLowerCase() === 'proveedor'
            "
            matSuffix
            mat-icon-button
            aria-label="Clear"
            (click)="proveedorSelected = undefined; $event.stopPropagation()"
          >
            <mat-icon>close</mat-icon>
          </div>
        </mat-form-field>
        <!-- Deposito -->
        <mat-form-field
          *ngIf="tipoInput.descripcion.toLowerCase() === 'deposito'"
          focused="false"
          appearance="outline"
        >
          <mat-label>{{ tipoInput.descripcion }}</mat-label>
          <mat-select
            *ngIf="tipoInput.descripcion.toLowerCase() === 'deposito'"
            [(ngModel)]="depositoSelected"
            name="deposito"
          >
            <mat-option
              *ngFor="let deposito of depositos"
              [value]="deposito.Numero"
            >
              {{ deposito.Detalle | uppercase }}
            </mat-option>
          </mat-select>
          <div
            clear-option
            mat-button
            *ngIf="
              depositoSelected &&
              tipoInput.descripcion.toLowerCase() === 'deposito'
            "
            matSuffix
            mat-icon-button
            aria-label="Clear"
            (click)="depositoSelected = undefined; $event.stopPropagation()"
          >
            <mat-icon>close</mat-icon>
          </div>
        </mat-form-field>
        <!-- Marca -->
        <mat-form-field
          *ngIf="tipoInput.descripcion.toLowerCase() === 'marca'"
          focused="false"
          appearance="outline"
        >
          <mat-label>{{ tipoInput.descripcion }}</mat-label>
          <mat-select
            *ngIf="tipoInput.descripcion.toLowerCase() === 'marca'"
            [(ngModel)]="marcaSelected"
            name="marca"
          >
            <mat-option *ngFor="let marca of marcas" [value]="marca.NroMarca">
              {{ marca.Detalle | uppercase }}
            </mat-option>
          </mat-select>
          <div
            clear-option
            mat-button
            *ngIf="
              marcaSelected && tipoInput.descripcion.toLowerCase() === 'marca'
            "
            matSuffix
            mat-icon-button
            aria-label="Clear"
            (click)="marcaSelected = undefined; $event.stopPropagation()"
          >
            <mat-icon>close</mat-icon>
          </div>
        </mat-form-field>
        <!-- Moneda -->
        <mat-form-field
          *ngIf="tipoInput.descripcion.toLowerCase() === 'moneda'"
          focused="false"
          appearance="outline"
        >
          <mat-label>{{ tipoInput.descripcion }}</mat-label>
          <mat-select
            *ngIf="tipoInput.descripcion.toLowerCase() === 'moneda'"
            [(ngModel)]="monedaSelected"
            name="moneda"
          >
            <mat-option *ngFor="let moneda of monedas" [value]="moneda.Moneda">
              {{ moneda.MonDescri | uppercase }}
            </mat-option>
          </mat-select>
          <div
            clear-option
            mat-button
            *ngIf="
              monedaSelected && tipoInput.descripcion.toLowerCase() === 'moneda'
            "
            matSuffix
            mat-icon-button
            aria-label="Clear"
            (click)="monedaSelected = undefined; $event.stopPropagation()"
          >
            <mat-icon>close</mat-icon>
          </div>
        </mat-form-field>
        <!-- Stock -->
        <mat-form-field
          *ngIf="tipoInput.descripcion.toLowerCase() === 'stock'"
          focused="false"
          appearance="outline"
        >
          <mat-label>{{ tipoInput.descripcion }}</mat-label>
          <mat-select
            *ngIf="tipoInput.descripcion.toLowerCase() === 'stock'"
            [(ngModel)]="stockSelected"
            name="stock"
          >
            <mat-option
              *ngFor="let stock of stockInput; let i = index"
              [value]="i"
            >
              {{ stock.descripcion | uppercase }}
            </mat-option>
          </mat-select>
          <div
            clear-option
            mat-button
            *ngIf="
              (stockSelected &&
                tipoInput.descripcion.toLowerCase() === 'stock') ||
              (stockSelected === 0 &&
                tipoInput.descripcion.toLowerCase() === 'stock')
            "
            matSuffix
            mat-icon-button
            aria-label="Clear"
            (click)="stockSelected = undefined; $event.stopPropagation()"
          >
            <mat-icon>close</mat-icon>
          </div>
        </mat-form-field>
        <!-- Novedad -->
        <mat-form-field
          *ngIf="tipoInput.descripcion.toLowerCase() === 'novedad'"
          focused="false"
          appearance="outline"
        >
          <mat-label>{{ tipoInput.descripcion }}</mat-label>
          <mat-select
            *ngIf="tipoInput.descripcion.toLowerCase() === 'novedad'"
            [(ngModel)]="novedadSelected"
            name="stock"
          >
            <mat-option
              *ngFor="let novedad of novedadInput; let i = index"
              [value]="i"
            >
              {{ novedad.descripcion | uppercase }}
            </mat-option>
          </mat-select>
          <div
            clear-option
            mat-button
            *ngIf="
              (novedadSelected &&
                tipoInput.descripcion.toLowerCase() === 'novedad') ||
              (novedadSelected === 0 &&
                tipoInput.descripcion.toLowerCase() === 'novedad')
            "
            matSuffix
            mat-icon-button
            aria-label="Clear"
            (click)="novedadSelected = undefined; $event.stopPropagation()"
          >
            <mat-icon>close</mat-icon>
          </div>
        </mat-form-field>
        <!-- Oferta -->
        <mat-form-field
          *ngIf="tipoInput.descripcion.toLowerCase() === 'oferta'"
          focused="false"
          appearance="outline"
        >
          <mat-label>{{ tipoInput.descripcion }}</mat-label>
          <mat-select
            *ngIf="tipoInput.descripcion.toLowerCase() === 'oferta'"
            [(ngModel)]="ofertaSelected"
            name="stock"
          >
            <mat-option
              *ngFor="let oferta of ofertaInput; let i = index"
              [value]="i"
            >
              {{ oferta.descripcion | uppercase }}
            </mat-option>
          </mat-select>
          <div
            clear-option
            mat-button
            *ngIf="
              (ofertaSelected &&
                tipoInput.descripcion.toLowerCase() === 'oferta') ||
              (ofertaSelected === 0 &&
                tipoInput.descripcion.toLowerCase() === 'oferta')
            "
            matSuffix
            mat-icon-button
            aria-label="Clear"
            (click)="ofertaSelected = undefined; $event.stopPropagation()"
          >
            <mat-icon>close</mat-icon>
          </div>
        </mat-form-field>
        <!-- Suspendido -->
        <mat-form-field
          *ngIf="tipoInput.descripcion.toLowerCase() === 'suspendido'"
          focused="false"
          appearance="outline"
        >
          <mat-label>{{ tipoInput.descripcion }}</mat-label>
          <mat-select
            *ngIf="tipoInput.descripcion.toLowerCase() === 'suspendido'"
            [(ngModel)]="suspendidoSelected"
            name="suspendido"
          >
            <mat-option
              *ngFor="let suspendido of suspendidoInput; let i = index"
              [value]="i"
            >
              {{ suspendido.descripcion | uppercase }}
            </mat-option>
          </mat-select>
          <div
            clear-option
            mat-button
            *ngIf="
              (suspendidoSelected &&
                tipoInput.descripcion.toLowerCase() === 'suspendido') ||
              (suspendidoSelected === 0 &&
                tipoInput.descripcion.toLowerCase() === 'suspendido')
            "
            matSuffix
            mat-icon-button
            aria-label="Clear"
            (click)="suspendidoSelected = undefined; $event.stopPropagation()"
          >
            <mat-icon>close</mat-icon>
          </div>
        </mat-form-field>
      </div>
    </div>

    <app-lista-inputs
      class=""
      listaInput="true"
      [listaInputs]="this.listaInputs"
      (listaChange_Event)="lista_Event($event)"
    ></app-lista-inputs>
    <div class="button-wrap">
      <button mat-raised-button color="primary">
        <span>Buscar</span>
      </button>
    </div>
  </form>
  <div>
    <mat-checkbox
      class="example-margin"
      [(ngModel)]="incluirVariantes"
      (change)="incluirVariante_Change()"
      [disabled]="this.cargando"
      >Incluir variantes</mat-checkbox
    >

    <div class="table-wrap">
      <div *ngIf="cargando" class="spinner-wrap">
        <mat-spinner [diameter]="80"></mat-spinner>
      </div>
      <div
        *ngIf="dataSource.length === 0 && !cargando && !this.errorEnServicios"
      >
        <h1 class="text-center">
          No se encontraron productos con los filtros establecidos
        </h1>
      </div>

      <table
        mat-table
        [dataSource]="dataSource"
        class="mat-elevation-z8"
        multiTemplateDataRows
        [ngClass]="this.cargando ? 'min-height' : ''"
      >
        <ng-container matColumnDef="codigo">
          <th
            class="producto-column small-colunm"
            mat-header-cell
            *matHeaderCellDef
          >
            Codigo
          </th>
          <td
            class="producto-column small-colunm"
            mat-cell
            *matCellDef="let element"
          >
            {{ element.Codigo }}
          </td>
        </ng-container>

        <ng-container matColumnDef="descripcion">
          <th
            class="producto-column large-colunm"
            mat-header-cell
            *matHeaderCellDef
          >
            Descripción
          </th>
          <td
            class="producto-column large-colunm"
            mat-cell
            *matCellDef="let element"
          >
            {{ element.Detalle }}
          </td>
        </ng-container>

        <ng-container matColumnDef="ubicacion">
          <th
            class="producto-column large-colunm"
            mat-header-cell
            *matHeaderCellDef
          >
            Ubicación
          </th>
          <td
            class="producto-column large-colunm"
            mat-cell
            *matCellDef="let element"
          >
            {{ element.Ubicacion }}
          </td>
        </ng-container>

        <ng-container matColumnDef="stockActual">
          <th
            class="producto-column small-colunm text-right"
            mat-header-cell
            *matHeaderCellDef
          >
            Stock Actual
          </th>
          <td
            class="producto-column small-colunm text-right"
            mat-cell
            *matCellDef="let element"
          >
            {{ element.StockActual | currency:'es-AR':'' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="precio1">
          <th
            class="producto-column small-colunm text-right"
            mat-header-cell
            *matHeaderCellDef
          >
            Precio 1
          </th>
          <td
            class="producto-column small-colunm text-right"
            mat-cell
            *matCellDef="let element"
          >
            {{ element.Precio1 | currency:'es-AR':'$' }}          
          </td>
        </ng-container>

        <ng-container matColumnDef="precio2">
          <th
            class="producto-column small-colunm text-right"
            mat-header-cell
            *matHeaderCellDef
          >
            Precio 2
          </th>
          <td
            class="producto-column small-colunm text-right"
            mat-cell
            *matCellDef="let element"
          >
            {{ element.Precio2 | currency:'es-AR':'$' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="costo">
          <th
            class="producto-column small-colunm text-right"
            mat-header-cell
            *matHeaderCellDef
            [hidden]="!this.securityAccess.validateAccess('MOSTRAR_COSTO')"
          >
            Costo
          </th>
          <td
            class="producto-column small-colunm text-right"
            mat-cell
            *matCellDef="let element"
            [hidden]="!this.securityAccess.validateAccess('MOSTRAR_COSTO')"
          >
            {{ element.Costo | currency:'es-AR':'$' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="ultiPrecio">
          <th
            class="producto-column small-colunm text-center"
            mat-header-cell
            *matHeaderCellDef
          >
            Ultimo Precio
          </th>
          <td
            class="producto-column small-colunm text-right"
            mat-cell
            *matCellDef="let element"
          >
            {{ element.UltiCambio | date: "dd/MM/yyyy" }}
          </td>
        </ng-container>

        <ng-container matColumnDef="ultiVenta">
          <th
            class="producto-column small-colunm text-center"
            mat-header-cell
            *matHeaderCellDef
          >
            Ultima Venta
          </th>
          <td
            class="producto-column small-colunm text-right"
            mat-cell
            *matCellDef="let element"
          >
            {{ element.UltiVenta | date: "dd/MM/yyyy" }}
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="columnasTabla"></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: columnasTabla"
          [class.example-expanded-row]="expandedElement === row"
          (click)="expandedElement = expandedElement === row ? null : row"
        ></tr>

        <ng-container matColumnDef="expandedDetail">
          <td
            mat-cell
            *matCellDef="let element"
            [attr.colspan]="columnasTabla.length"
          >
            <div
              class="example-element-detail"
              [@detailExpand]="
                element == expandedElement ? 'expanded' : 'collapsed'
              "
            >
              <div class="options-wrap">
                <button class="ml-1" mat-raised-button color="primary">
                  <span>Nuevo</span>
                  <!-- <mat-spinner [diameter]="25"></mat-spinner> -->
                </button>
                <button
                  class="ml-1"
                  mat-raised-button
                  color="primary"
                  (click)="openDialog(element, 'movimientos')"
                >
                  <span>Movimientos</span>
                  <!-- <mat-spinner [diameter]="25"></mat-spinner> -->
                </button>

                <button
                  class="ml-1"
                  mat-raised-button
                  color="primary"
                  (click)="delete(element)"
                  [disabled]="
                    !this.securityAccess.validateAccess('BORRAR_PRODUCTO')
                  "
                >
                  <span>Borrar</span>
                  <!-- <mat-spinner [diameter]="25"></mat-spinner> -->
                </button>

                <button class="ml-1" mat-raised-button color="primary">
                  <span>Agenda</span>
                  <!-- <mat-spinner [diameter]="25"></mat-spinner> -->
                </button>

                <button class="ml-1" mat-raised-button color="primary">
                  <span>Modificar</span>
                  <!-- <mat-spinner [diameter]="25"></mat-spinner> -->
                </button>
                <button
                  class="ml-1"
                  mat-raised-button
                  color="primary"
                  (click)="openDialog(element, 'inicio')"
                >
                  <span>Stock Inicial</span>
                  <!-- <mat-spinner [diameter]="25"></mat-spinner> -->
                </button>

                <button
                  class="ml-1"
                  mat-raised-button
                  color="primary"
                  (click)="openDialog(element, 'ajuste')"
                >
                  <span>Ajustar stock</span>
                  <!-- <mat-spinner [diameter]="25"></mat-spinner> -->
                </button>
              </div>
            </div>
          </td>
        </ng-container>

        <tr
          mat-row
          *matRowDef="let row; columns: ['expandedDetail']"
          class="example-detail-row"
        ></tr>
      </table>
    </div>
    <div class="footer">
      <h3 *ngIf="dataSource.length">Total Productos {{ totalRows }}</h3>
      <mat-paginator
        #paginator
        [length]="totalRows"
        [pageIndex]="page - 1"
        [pageSizeOptions]="[5, 10, 50, 100]"
        (page)="pagesChange($event)"
        [pageSize]="pageSize"
        aria-label="Select page"
      >
      </mat-paginator>
    </div>
  </div>
</div>
